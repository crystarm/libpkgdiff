# Multi-stage build using ALT Linux as the base image.
# Stage 1: build
FROM docker.io/alt:p11 AS build

# Install toolchain and headers
RUN apt-get update && \
    apt-get dist-upgrade -y && \
    apt-get install -y \
        gcc \
        make \
        pkg-config \
        ca-certificates \
        curl \
        libcurl-devel \
        "pkgconfig(jansson)" && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /work
COPY . /work

# Build
RUN make

# Stage 2: runtime
FROM docker.io/alt:p11

# Runtime deps only
RUN apt-get update && \
    apt-get install -y \
        ca-certificates \
        libcurl \
        libjansson4 && \
    rm -rf /var/lib/apt/lists/*

# Artifacts
COPY --from=build /work/pkgdiff /usr/bin/pkgdiff
COPY --from=build /work/libpkgdiff.so /usr/lib64/

# Shared libs path
ENV LD_LIBRARY_PATH=/usr/lib64:/usr/lib
ENV SSL_CERT_DIR=/etc/ssl/certs

WORKDIR /work
ENTRYPOINT ["/usr/bin/pkgdiff"]
